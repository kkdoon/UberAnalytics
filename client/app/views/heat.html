<h3>Trip Density</h3>
<div class="panel panel-primary">
  <div class="panel-heading">
    <h4>Trip Density Heat Map</h4>
  </div>
  <div class="panel-body">
    <div id = 'load' class="text-center hide" style="margin-left: 45%"></div>
    <div id='map'>
    </div>
    <script>
      L.mapbox.accessToken = 'pk.eyJ1Ijoia2tkb29uIiwiYSI6ImNpdWMwanltYjAwNmIyeXAyejBxYjlkY2QifQ.kdMjB6xkE-W-P4ff4y0ujg';
      var loader = document.getElementById('load');
      var map = L.mapbox.map('map', 'mapbox.streets')
        .setView([40.77, -73.88], 13);
      var heat;
      var featureGroup = L.featureGroup().addTo(map);

      var drawControl = new L.Control.Draw({
        edit: {
          featureGroup: featureGroup
        },
        draw: {
          polygon: true,
          polyline: false,
          rectangle: false,
          circle: false,
          marker: false
        }
      }).addTo(map);

      map.on('draw:created', showPolygonArea);
      map.on('draw:edited', showPolygonAreaEdited);

      function showPolygonAreaEdited(e) {
        e.layers.eachLayer(function(layer) {
          showPolygonArea({ layer: layer });
        });
      }

      function showPolygonArea(e) {
        featureGroup.clearLayers();
        featureGroup.addLayer(e.layer);
        e.layer.bindPopup((LGeo.area(e.layer) / 1000000).toFixed(2) + ' km<sup>2</sup>');
        e.layer.openPopup();
        var requestObj = getPolygonJsonArray(e.layer._latlngs);
        startLoading();
        var result = fetchTopPickups(requestObj);
        if(result != null) {
          plotTopPickups(result);
        }
        finishedLoading();
      }

      function fetchTopPickups(json) {
        $.ajax({
          'url' : 'http://localhost:8080/v1/draw/clusterTrips?polygon=' + json ,
          'type' : 'GET',
          'success' : function(data) {
            plotTopPickups(data);
          },
          'error': function (xhr, status, errorThrown) {
            alert('Error Code: ' +  xhr.status + ' Message:' + xhr.responseText);
            finishedLoading();
          }
        });
      }

      function getPolygonJsonArray(latlongArray){
        var resultJson = [];
        for(var obj in latlongArray)
        {
          var json = [];
          json.push(latlongArray[obj].lng);
          json.push(latlongArray[obj].lat);
          resultJson.push(json);
        }

        if(resultJson.length > 0){
          var json = [];
          json.push(resultJson[0][0]);
          json.push(resultJson[0][1]);
          resultJson.push(json);
        }
        return resultJson;
      }

      function plotTopPickups(json){
        if(heat){
         // heat.clearLayers();
        }
        heat = L.heatLayer(json, {maxZoom: 18}).addTo(map);
        finishedLoading();
      }

      function startLoading() {
        loader.className = 'show';
      }

      function finishedLoading() {
        // first, toggle the class 'done', which makes the loading screen
        // fade out
        //loader.className = 'done';
        setTimeout(function() {
          // then, after a half-second, add the class 'hide', which hides
          // it completely and ensures that the user can interact with the
          // map again.
          loader.className = 'hide';
        }, 2000);
      }

    </script>
  </div>
</div>
