<h3>Top Pickup Points</h3>
<div class="panel panel-primary">
  <div class="panel-heading">
    <h4>Pickup Map</h4>
  </div>
  <div class="panel-body">
    <div id = 'load' class="text-center hide" style="margin-left: 45%"></div>
    <div id='map'>
    </div>
    <!--pre id='coordinates' class='ui-coordinates'></-pre!-->
    <!--div id='loader' class="hide"><span class='message'>loading</span></div!-->
    <script>
      L.mapbox.accessToken = 'pk.eyJ1Ijoia2tkb29uIiwiYSI6ImNpdWMwanltYjAwNmIyeXAyejBxYjlkY2QifQ.kdMjB6xkE-W-P4ff4y0ujg';
      var loader = document.getElementById('load');
      var map = L.mapbox.map('map', 'mapbox.streets')
        //.setView([-37.82, 175.215], 14);
        .setView([40.77, -73.88], 11);
      var heat;
      var markers = new L.MarkerClusterGroup();
      var featureGroup = L.featureGroup().addTo(map);
      /*var featureLayer = L.mapbox.featureLayer()
        .loadURL('http://localhost:8080/v1/draw/trip')
        .addTo(map);*/

      var drawControl = new L.Control.Draw({
        edit: {
          featureGroup: featureGroup
        },
        draw: {
          polygon: true,
          polyline: false,
          rectangle: false,
          circle: false,
          marker: false
        }
      }).addTo(map);

      map.on('draw:created', showPolygonArea);
      map.on('draw:edited', showPolygonAreaEdited);

      function showPolygonAreaEdited(e) {
        e.layers.eachLayer(function(layer) {
          showPolygonArea({ layer: layer });
        });
      }

      function showPolygonArea(e) {
        featureGroup.clearLayers();
        featureGroup.addLayer(e.layer);
        //console.log(e.layer._latlngs);
        e.layer.bindPopup((LGeo.area(e.layer) / 1000000).toFixed(2) + ' km<sup>2</sup>');
        e.layer.openPopup();
        var requestObj = getPolygonJsonArray(e.layer._latlngs);
        startLoading();
        var result = fetchTopPickups(requestObj);
        if(result != null) {
          plotTopPickups(result);
        }
        finishedLoading();
      }

      function fetchTopPickups(json) {
        $.ajax({
          'url' : 'http://localhost:8080/v1/draw/clusterPickups?polygon=' + json ,
          'type' : 'GET',
          'success' : function(data) {
            //return data;
            plotTopPickups(data);
          },
          'error': function (xhr, status, errorThrown) {
            alert('Error Code: ' +  xhr.status + ' Message:' + xhr.responseText);
            finishedLoading();
          }
        });
        /*angular.module('clientApp').controller('PickupsCtrl', ['$scope', 'topPickupPoints', function ($scope, notify) {
          console.log(notify);
        }]);*/
      }



      function getPolygonJsonArray(latlongArray){
        var resultJson = [];
        for(var obj in latlongArray)
        {
          var json = [];
          json.push(latlongArray[obj].lng);
          json.push(latlongArray[obj].lat);
          resultJson.push(json);
        }

        if(resultJson.length > 0){
          var json = [];
          json.push(resultJson[0][0]);
          json.push(resultJson[0][1]);
          resultJson.push(json);
        }
        return resultJson;
      }

      function plotTopPickups(json){
        //heat = L.heatLayer(json, {maxZoom: 18}).addTo(map);
        markers.clearLayers();
        for (var i = 0; i < json.length; i++) {
          var a = json[i];
          var title = a[2];
          var marker = L.marker(new L.LatLng(a[0], a[1]), {
            icon: L.mapbox.marker.icon({'marker-symbol': 'post', 'marker-color': '0044FF'}),
            title: title
          });
          marker.bindPopup(title);
          markers.addLayer(marker);
        }
        map.addLayer(markers);
        finishedLoading();
      }

      function startLoading() {
        loader.className = 'show';
      }

      function finishedLoading() {
        // first, toggle the class 'done', which makes the loading screen
        // fade out
        //loader.className = 'done';
        setTimeout(function() {
          // then, after a half-second, add the class 'hide', which hides
          // it completely and ensures that the user can interact with the
          // map again.
          loader.className = 'hide';
        }, 500);
      }

      function onmove() {
        // Get the map bounds - the top-left and bottom-right locations.
        var inBounds = [],
          bounds = map.getBounds();
        markers.eachLayer(function(marker) {
          // For each marker, consider whether it is currently visible by comparing
          // with the current map bounds.
          if (bounds.contains(marker.getLatLng())) {
            inBounds.push(marker.options.title);
          }
        });
        // Display a list of markers.
        //document.getElementById('coordinates').innerHTML = inBounds.join('\n');
      }

      map.on('move', onmove);
      onmove();
    </script>
  </div>
</div>
